# ADR-005: 採用 Apache Kafka 將核心通訊模式重構為非同步事件驅動

**狀態：** 已接納 (Accepted)
**日期：** 【2025-09-07】

---

## 背景 (Context)

隨著「第三幕：全知之眼」的開啟，我們的核心目標轉向了**「洞察與掌控」**。當前的架構，雖然在「第二幕」中得到了安全強化，但其服務間的通訊模式仍然是隱含的、點對點的同步調用。

這種同步模式存在幾個根本性的、阻礙我們實現「全知之眼」的戰略缺陷：

1.  **緊密耦合 (Tight Coupling):** `gateway-service` 需要直接知道 `beacon-service` 的存在與地址。未來任何需要對同一事件做出反應的新服務，都必須修改 `gateway-service` 的程式碼，這違反了低耦合原則。
2.  **韌性脆弱 (Poor Resilience):** 如果 `beacon-service` 暫時不可用或回應緩慢，`gateway-service` 將直接受到衝擊，可能導致線程阻塞和資源耗盡，這與我們在「第二幕」建立的韌性哲學相悖。
3.  **缺乏可觀測性 (Lack of Observability):** 服務間的直接調用是瞬時的、無形的「幽靈鏈路」。我們無法輕易地對系統內部的核心業務事件進行**攔截、審計、重放或分析**。

為了點亮「全知之眼」，我們必須將這些無形的「幽靈鏈路」，轉化為有形的、可被觀測的 **「訊息洪流」**。

## 決策 (Decision)

我們決定引入 **Apache Kafka** 作為我們宇宙的 **「中央神經系統」**，並將核心服務間的通訊，從同步的「請求-回應」模式，重構為非同步的 **「發布-訂閱」** 事件驅動模式。

具體的實施策略如下：

1.  **引入 Kafka 作為消息 middleware：** 我們將在 `docker-compose.yml` 中，正式添加 Apache Kafka 及其相關依賴（如 KRaft/Zookeeper）的服務定義。
2.  **重構 `gateway-service` 為「事件生產者」：** `gateway-service` 在接收到外部請求並完成認證後，不再直接調用下游服務。取而代之，它將生產一個定義清晰的業務事件（例如 `BeaconEvent`），並將其發布到一個指定的 Kafka 主題（Topic）中（例如 `topic.beacon.events`）。
3.  **重構 `beacon-service` 為「事件消費者」：** `beacon-service` 將被改造為一個 Kafka 消費者，它將訂閱 `topic.beacon.events` 主題。一旦有新的事件到達，它將獲取該事件並執行其核心業務邏輯。

## 理由 (Consequences)

### 積極方面：

*   **極致解耦 (Radical Decoupling):**
    *   **空間解耦：** 生產者和消費者無需知道彼此的網絡位置。
    *   **時間解耦：** 生產者和消費者無需同時 online。如果 `beacon-service` 當機，事件將在 Kafka 中安全地排隊，待其恢復後繼續處理。這極大地提升了整個系統的**韌性**。
*   **卓越的可擴展性與可演進性 (Superior Scalability & Evolvability):**
    *   我們可以輕易地增加**新的消費者**（例如，一個用於審計的 `auditing-service`，一個用於發送通知的 `notification-service`），讓它們訂閱同一個主題，而**無需對 `gateway-service` 進行任何修改**。這是實現複雜業務流程演進的關鍵。
*   **「全知之眼」的基石 (Foundation for Observability):**
    *   Kafka 的主題，成為了我們系統中**業務事件的、持久化的、可回溯的「真理之源」**。我們可以輕易地接入監控工具（如 Prometheus）、日誌系統（如 Loki）和追蹤系統（如 Tempo/Jaeger），來觀測這條「訊息洪流」的健康狀況、流速和內容。**這使得「洞察」成為可能。**

### 消極方面（權衡）：

*   **引入了顯著的運維複雜性 (Increased Operational Complexity):** Kafka 是一個強大的、但也是複雜的分布式系統。在我們的「沙盤微縮宇宙」中運行它，將會顯著增加資源消耗，並引入新的潛在故障點。
*   **非同步程式的心智模型 (Mental Model of Asynchronicity):** 開發和調試非同步系統，比同步系統更具挑戰性。錯誤處理、結果返回、端到端追蹤都需要一套全新的思維模式。這正是「第三幕」需要解決的核心挑戰。
*   **最終一致性 (Eventual Consistency):** 我們從一個「請求後立即得到結果」的強一致性模型，轉向了「請求後，結果將在未來的某個時間點達成」的最終一致性模型。這需要對 API 的設計和客戶端的交互模式進行相應的調整。

---
**文件結束**