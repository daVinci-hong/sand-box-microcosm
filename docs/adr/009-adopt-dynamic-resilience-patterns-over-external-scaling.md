# ADR-009 (v2.0): 採用 Resilience4j 實現動態韌性策略，取代外部擴縮容隱喻

**狀態：** 已接納 (Accepted)
**日期：** 【2025-09-14】

---

## 背景 (Context)

原 `ADR-009 (v1.0)` 提議，通過一個外部的 Webhook 接收器，來調用 `docker-compose scale` 命令，以「隱喻」自動擴縮容。

經過對「自動化測試體系」重要性的深度覆盤，我們識別出原方案存在三個根本性的戰略缺陷：
1.  **脆弱性 (Brittleness):** 該機制依賴於一個脆弱的、與主機環境強耦合的外部腳本，穩定性差。
2.  **不可測試性 (Untestability):** 該機制的觸發與執行，極難被納入我們即將建立的單元/整合測試體系中，其正確性無法得到自動化的、可靠的保證。
3.  **偏離現實 (Deviation from Reality):** 它並未真正地模擬生產環境中，應用程序**自身**應對負載的韌性模式，而是採用了一種與生產級實踐（如 Kubernetes HPA）貌合神離的簡化方案。

我們需要一個更健壯、更專業、更可被測試的方案，來真正地演繹「第四幕」的核心——**彈性與自適應**。

## 決策 (Decision)

我們決定**廢棄**原有的、基於外部腳本的自動擴縮容方案。

取而代之，我們將**深度整合並擴展**我們在「第二幕」已引入的 **Resilience4j** 技術集，將其從一個靜態的防禦工事，升級為一個**動態的、可被觀測的、自適應的韌性系統**。

具體的實施策略如下：

1.  **引入全套韌性武器庫：** 我們將在 `gateway-service` 中，全面啟用 Resilience4j 的三大核心韌性模式：
    *   **熔斷器 (Circuit Breaker):** 防止對下游服務的級聯故障。（已引入，待強化）
    *   **限流器 (Rate Limiter):** 在流量洪峰時，主動拋棄超出系統處理能力的請求，保護系統不被壓垮。
    *   **艙壁隔離 (Bulkhead):** 限制對特定資源的併發調用數量，將潛在的故障，隔離在一個小範圍內。

2.  **實現動態配置：** 我們將利用 Spring Boot Actuator，使這些韌性模式的**核心參數**（如熔斷閾值、限流速率）能夠在**運行時，通過 API 動態調整**，以展示系統的自適應能力。

3.  **指標的深度暴露：** 我們將配置 Resilience4j，使其將所有韌性組件的**內部狀態指標**（如熔斷器是開啟/關閉，限流器允許/拒絕的請求數），全部暴露給 Prometheus。

4.  **可視化的戰情室：** 我們將在 Grafana 中，創建一個**專門的「韌性戰情室」儀表板**，用於實時可視化這些韌性指標的變化。

## 理由 (Consequences)

### 積極方面：

*   **生產級的真實性 (Production-Grade Realism):**
    *   這套基於 Rate Limiting, Circuit Breaking, Bulkheading 的組合拳，是**真實世界**中，構建高可用微服務的**黃金標準**。它比原方案，更能體現我們的專業深度。
*   **100% 可被測試 (100% Testable):**
    *   Resilience4j 的所有行為，都可以被精確地、穩定地，在我們的**單元測試和整合測試**中進行驗證。這完美地契合了我們「橫貫任務 C.1」的核心目標。
*   **完美的敘事閉環 (Perfect Narrative Loop):**
    *   此方案創造了一個無與倫比的演示故事：我們使用 **k6** 發起「流量洪峰」，然後在 **Grafana** 的「韌性戰情室」儀表板上，**實時觀看**限流器如何拒絕請求、熔斷器如何打開、艙壁如何隔離故障。這是一個**視覺衝擊力極強**的、關於「不屈的堡壘」的英雄故事。
*   **深化「全知之眼」：**
    *   它將「第三幕」建立的「可觀測性」，從「被動觀察」，提升到了 **「指導主動防禦」** 的全新高度。

### 消極方面（權衡）：

*   **敘事焦點的轉移：** 我們必須明確，我們不再演示「水平擴展 (Scale Out)」，我們演示的是 **「垂直韌性 (Vertical Resilience)」**。這是一個戰略性的選擇，我們認為後者更能體現架構的深度與成熟度。

---
**文件結束**