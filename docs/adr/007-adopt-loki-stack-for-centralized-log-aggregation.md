# ADR-007: 採用 Loki 技術集進行集中式日誌聚合

**狀態：** 已接納 (Accepted)
**日期：** 【2025-09-09】

---

## 背景 (Context)

在 `ADR-006` 中，我們成功地為宇宙安裝了「指標之眼」，使其擁有了可被量化的「心跳與脈搏」。然而，指標只能告訴我們**「發生了什麼 (What)」**（例如：CPU 負載過高），卻無法告訴我們**「為什麼會發生 (Why)」**。

要回答「為什麼」，我們必須能夠聆聽我們宇宙內部所有組件的**「對話與獨白」**——也就是它們的日誌。

當前，我們的日誌散落在各個獨立的 Docker 容器中，它們是**短暫的 (Ephemeral)、無結構的 (Unstructured)、且難以查詢的 (Unqueryable)**。在一個分布式系統中，試圖通過手動 `docker logs` 來排查一個跨越多個服務的問題，無異於大海撈針。

## 決策 (Decision)

我們決定採用以 **Grafana Loki** 為核心的技術集，作為我們宇宙中日誌聚合、存儲與查詢的標準解決方案。

具體的實施策略如下：

1.  **日誌格式化 (Formatting):**
    *   我們將強制要求所有微服務，必須產生**結構化的 JSON 日誌**。我們將使用 `logstash-logback-encoder` 庫，來將傳統的文本日誌，轉化為包含豐富上下文（如時間戳、日誌級別、線程名、Trace ID 等）的 JSON 對象。

2.  **日誌採集 (Collection):**
    *   我們將部署 **Promtail** 作為我們的日誌採集代理。Promtail 將自動發現我們所有的 Docker 容器，抓取它們的日誌流，並將其轉發給 Loki。

3.  **日誌存儲與索引 (Storage & Indexing):**
    *   我們將部署 **Loki** 作為我們的集中式日誌存儲系統。Loki 將負責接收來自 Promtail 的日誌，並基於一組高效的 Metadata 標籤（如 `container`, `job`）對其進行索引。

4.  **日誌可視化與查詢 (Visualization & Querying):**
    *   我們將利用現有的 **Grafana** 實例，將 Loki 添加為一個新的資料源。我們將使用 Grafana 強大的 Explore 功能和 LogQL 查詢語言，來進行日誌的交互式查詢、過濾和分析。

## 理由 (Consequences)

### 積極方面：

*   **與指標的完美協同 (Perfect Synergy with Metrics):**
    *   Loki 的設計哲學，是**「像 Prometheus 一樣對待日誌」**。它使用與 Prometheus 完全相同的標籤模型 (`{key="value"}`) 來進行索引。這使得我們可以在**同一個 Grafana 儀表板**中，無縫地將**指標（例如一次延遲尖峰）與觸發該指標的具體日誌**關聯起來。這是實現「全知之眼」的、最具戰略價值的特性。
*   **資源效率 (Resource Efficiency):**
    *   與傳統的全文索引日誌系統（如 ELK Stack）不同，Loki **只索引日誌的 Metadata 標籤，而不索引日誌的全文內容**。這使得它的存儲成本和內存消耗**極低**，完美契合我們「沙盤微縮宇宙」的精要主義原則。
*   **簡潔的架構 (Simple Architecture):**
    *   Promtail 是一個輕量級的、職責單一的代理，易於配置。整個 Loki 集合的組件數量和複雜性，遠低於 ELK 等替代方案，使其非常適合在本地開發環境中部署。
*   **結構化日誌的力量 (Power of Structured Logging):**
    *   強制使用 JSON 日誌，意味著我們的日誌不再是無意義的字符串。它們是**可被機器解析的資料**。我們可以在 Grafana 中，對 JSON 字段進行過濾、解析和統計，從而實現遠超傳統文本搜索的、更深層次的洞察。

### 消極方面（權衡）：

*   **查詢能力的局限性 (Limited Query Power):**
    *   Loki 的高效，是以犧牲部分查詢能力為代價的。它的 LogQL 查詢語言，在基於標籤的過濾上非常強大，但在對日誌內容進行複雜的全文搜索和聚合分析方面，不如 Elasticsearch 等全文搜索引擎。對於我們排查故障的核心需求而言，這是一個完全可以接受的權衡。
*   **對標籤的強依賴 (Heavy Reliance on Labels):**
    *   Loki 系統的性能和可用性，高度依賴於良好、一致的標籤策略。設計一套高效的標籤體系，是我們未來需要持續關注的紀律。

---
**文件結束**