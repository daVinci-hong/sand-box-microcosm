# ADR-004: 採用 Trivy 在 CI 流程中進行容器鏡像漏洞掃描

**狀態：** 已接納 (Accepted)
**日期：** 【2025-09-06】

---

## 背景 (Context)

我們的「拉取請求質量閘門」目前能夠有效地驗證代碼的**功能正確性**（通過單元測試）和**可構建性**（通過 Maven 和 Docker 構建）。然而，它缺乏一個至關重要的維度：**安全性**。

我們構建的 Docker 鏡像，其基礎操作系統（如 Alpine Linux）和應用程序依賴，都可能包含已知的安全漏洞 (CVEs)。如果我們將一個帶有高危漏洞的鏡像部署到生產環境，那麼即使我們的業務邏輯完美無瑕，整個「零信任堡壘」也可能因為一個已知的漏洞而被輕易攻破。

我們必須將安全檢查，從一個「事後」的手動活動，轉變為一個「事前」的、內建於開發流程中的自動化紀律。

## 決策 (Decision)

我們決定在我們的 CI 工作流 (`.github/workflows/ci.yml`) 中，正式集成 **Trivy**，一個開源的、綜合性的安全掃描器。

具體的實施策略如下：

1.  **集成點：** Trivy 掃描將作為我們「拉取請求質量閘門」中的一個**強制性步驟**，緊跟在 Docker 鏡像成功構建之後。
2.  **掃描目標：** Trivy 將負責掃描我們為 `gateway-service` 和 `beacon-service` 構建的 Docker 鏡像。
3.  **失敗策略：** 我們將配置 Trivy，當掃描到**嚴重級別 (HIGH) 或危急級別 (CRITICAL)** 的漏洞時，立即**中斷 CI 管道並使其失敗**。這將物理上阻止任何帶有已知高危漏洞的代碼被合併到 `main` 分支。
4.  **實現工具：** 我們將使用官方推薦的 `aquasecurity/trivy-action` GitHub Action 來簡化集成過程。

## 理由 (Consequences)

### 積極方面：

*   **安全左移 (Shift-Left Security)：** 這是此決策的核心價值。我們在開發生命週期的最早階段（代碼合併前）就發現並攔截安全漏洞，而不是在部署後才去應對。這極大地降低了修復成本和安全風險。
*   **自動化與強制性 (Automation & Enforcement)：** 將安全掃描變為 CI 流程的一部分，確保了它**永遠不會被遺忘或繞過**。它將安全，從一種「最佳實踐」的倡議，提升為一種**鋼鐵般的、由機器強制執行的紀律**。
*   **易於集成與維護 (Ease of Integration & Maintenance)：** 使用現成的 `trivy-action`，使得集成工作變得非常簡單。Trivy 的漏洞數據庫會自動更新，確保我們總是在用最新的情報進行掃描。
*   **敘事一致性 (Narrative Cohesion)：** 此舉完美地踐行了「第二幕：零信任堡壘」和「治未病」的核心哲學。一個不檢查建築材料是否存在缺陷的堡壘，其「零信任」是空談。

### 消極方面（權衡）：

*   **增加 CI 執行時間 (Increased CI Runtime)：** 漏洞掃描會為我們的 CI 管道增加 1-2 分鐘的執行時間。考慮到它所提供的巨大安全保障，這是一個完全可以接受的、極具價值的投資。
*   **潛在的誤報與噪音 (Potential for False Positives & Noise)：** 任何安全掃描器都可能報告一些在我們特定上下文中並不構成實際威脅的漏洞。在 POC 階段，我們將採取一個嚴格的策略（發現即失敗），但在真實的生產環境中，可能需要建立一個流程來評估和豁免某些特定的漏洞。

---
**文件結束**